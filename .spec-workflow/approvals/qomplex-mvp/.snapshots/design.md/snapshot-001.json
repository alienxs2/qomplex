{
  "id": "snapshot_1764621731343_9eb7t4ale",
  "approvalId": "approval_1764621731339_3kgh9unsg",
  "approvalTitle": "Design Document",
  "version": 1,
  "timestamp": "2025-12-01T20:42:11.343Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Qomplex MVP\n\n## Overview\n\nQomplex is a web interface for Claude Code CLI that enables users to interact with AI agents from any device. The system provides a mobile-first, responsive UI for managing projects, chatting with specialized AI agents, and viewing project documentation. The architecture follows a client-server model with WebSocket for real-time communication and direct CLI integration via child_process.spawn().\n\n**Key differentiators from existing solutions:**\n- No API key required - uses existing Claude Code CLI with MAX subscription\n- 7 pre-configured agents per project for specialized tasks\n- Session persistence via CLI transcript files\n- Mobile-first design with Telegram-style UI\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n*Note: Steering documents not yet created for this project. The following standards are established:*\n\n- **TypeScript Strict Mode:** All code uses TypeScript with strict compilation\n- **ES Modules:** Using ESM throughout the monorepo\n- **Shared Types:** Common types in `/shared` package for consistency\n- **Validation:** Zod schemas for runtime validation on API boundaries\n- **Logging:** Pino for structured JSON logging\n- **Testing:** Vitest for unit and integration tests\n\n### Project Structure (structure.md)\n*Reference structure based on requirements:*\n\n```\nqomplex/\n  frontend/           # React 18 + Vite + TailwindCSS\n    src/\n      components/     # UI components\n      hooks/          # Custom React hooks\n      store/          # Zustand state stores\n      pages/          # Page components\n      lib/            # Utilities\n      types/          # TypeScript types\n  backend/            # Node.js + Express + WebSocket\n    src/\n      services/       # Business logic\n      routes/         # Express routes\n      websocket/      # WebSocket handlers\n      types/          # TypeScript types\n  shared/             # Shared types and utilities\n    src/\n      schemas/        # Zod schemas\n      types/          # Shared TypeScript types\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\nFrom **clipendra-repo**:\n\n- **DirectoryBrowser** (`/home/dev/clipendra-repo/app/frontend/src/components/DirectoryBrowser.tsx`):\n  Fully reusable modal for browsing server filesystem. Provides breadcrumb navigation, path ownership checking, and touch-friendly interface. Adaptation: Replace `useUserStore` with Qomplex auth context.\n\n- **TelegramLayout** (`/home/dev/clipendra-repo/app/frontend/src/components/TelegramLayout.tsx`):\n  Reference for mobile-first responsive layout with 3-panel desktop view and single-panel mobile view. Pattern: Desktop header + 3 panels (ChatList, Chat, Info).\n\n- **ClaudeCliService** (`/home/dev/clipendra-repo/app/backend/src/services/claude-cli.service.ts`):\n  Core service for spawning Claude CLI processes. Provides streaming output, session ID extraction, timeout handling, and error mapping. Direct reuse with minimal adaptation.\n\n- **WebSocket Handler** (`/home/dev/clipendra-repo/app/backend/src/websocket/handler.ts`):\n  Pattern for WebSocket message routing, agent settings loading, and CLI process management. Adaptation: Add JWT authentication, agent system prompts from DB.\n\n- **useWebSocket Hook** (`/home/dev/clipendra-repo/app/frontend/src/hooks/useWebSocket.ts`):\n  React hook for WebSocket connection with reconnection logic, message queue, and context usage tracking. Direct reuse.\n\n- **MessageBubble** (`/home/dev/clipendra-repo/app/frontend/src/components/MessageBubble.tsx`):\n  Telegram-style message bubble with markdown rendering and syntax highlighting. Direct reuse.\n\n- **userStore** (`/home/dev/clipendra-repo/app/frontend/src/store/userStore.ts`):\n  Pattern for Zustand store with persist middleware. Adaptation: Replace user list with JWT auth.\n\nFrom **bolt_ai_front_clone**:\n\n- **Layout Pattern** (`/home/dev/bolt_ai_front_clone/src/App.tsx`):\n  Mobile view state management (`MobileView` type), tab management, and swipe navigation. Pattern for agent/doc tab handling.\n\n- **MobileTabSwitcher** (`/home/dev/bolt_ai_front_clone/src/components/MobileTabSwitcher.tsx`):\n  Bottom sheet for mobile tab selection. Direct reuse with styling adaptation.\n\n### Integration Points\n\n- **CLI Integration:** `child_process.spawn()` with `--output-format stream-json` for NDJSON streaming\n- **Session Resume:** `--resume <session_id>` or `--continue` for session continuity\n- **Agent System Prompts:** `--append-system-prompt` for per-agent instructions\n- **Transcript Files:** Read from `~/.claude/projects/<hash>/sessions/*.jsonl` for history\n\n## Architecture\n\nThe system follows a client-server architecture with three main layers:\n\n1. **Frontend (React SPA):** Mobile-first UI with responsive desktop layout\n2. **Backend (Express + WebSocket):** API gateway and CLI process manager\n3. **Database (PostgreSQL):** User data, projects, agents, and session metadata\n\n### High-Level Architecture\n\n```mermaid\ngraph TD\n    subgraph Client[\"Frontend (Browser)\"]\n        UI[React UI]\n        WS_CLIENT[WebSocket Client]\n        ZUSTAND[Zustand Stores]\n    end\n\n    subgraph Server[\"Backend (Node.js)\"]\n        EXPRESS[Express Server]\n        WS_SERVER[WebSocket Server]\n        CLI_SERVICE[ClaudeCliService]\n        AUTH[Auth Middleware]\n    end\n\n    subgraph External[\"External\"]\n        CLI[Claude CLI]\n        TRANSCRIPTS[~/.claude/transcripts]\n        PG[(PostgreSQL)]\n    end\n\n    UI --> ZUSTAND\n    UI <--> WS_CLIENT\n    WS_CLIENT <--> WS_SERVER\n    UI --> EXPRESS\n    EXPRESS --> AUTH\n    AUTH --> PG\n    WS_SERVER --> CLI_SERVICE\n    CLI_SERVICE --> CLI\n    CLI_SERVICE --> TRANSCRIPTS\n    EXPRESS --> PG\n```\n\n### Request Flow: Chat Message\n\n```mermaid\nsequenceDiagram\n    participant U as User\n    participant F as Frontend\n    participant WS as WebSocket\n    participant BE as Backend\n    participant CLI as Claude CLI\n    participant DB as PostgreSQL\n\n    U->>F: Send message\n    F->>WS: query { prompt, agentId, projectId }\n    WS->>BE: Validate JWT\n    BE->>DB: Get agent system prompt\n    BE->>CLI: spawn claude -p \"prompt\" --append-system-prompt\n    CLI-->>BE: NDJSON stream (system, assistant, result)\n    BE-->>WS: stream { content }\n    WS-->>F: Update UI\n    BE->>DB: Save session metadata\n    CLI-->>BE: result event\n    BE-->>WS: complete { usage, cost }\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility:** Each component/service handles one concern\n- **Component Isolation:** Small, focused components (avg 100-200 lines)\n- **Service Layer Separation:** ClaudeCliService, AuthService, AgentService\n- **Utility Modularity:** Separate utils for parsing, validation, formatting\n\n## Components and Interfaces\n\n### Frontend Components\n\n#### 1. AuthProvider\n- **Purpose:** JWT authentication context and protected routes\n- **Interfaces:**\n  ```typescript\n  interface AuthContext {\n    user: User | null;\n    token: string | null;\n    login: (email: string, password: string) => Promise<void>;\n    register: (email: string, password: string) => Promise<void>;\n    logout: () => void;\n    isLoading: boolean;\n  }\n  ```\n- **Dependencies:** None (root provider)\n- **Reuses:** Pattern from clipendra userStore for state management\n\n#### 2. MainLayout\n- **Purpose:** Responsive layout with mobile/desktop switching\n- **Interfaces:**\n  ```typescript\n  interface MainLayoutProps {\n    children: React.ReactNode;\n  }\n  ```\n- **Dependencies:** AuthProvider, Zustand stores\n- **Reuses:** TelegramLayout pattern from clipendra\n\n#### 3. ProjectSelector\n- **Purpose:** Dropdown for selecting active project\n- **Interfaces:**\n  ```typescript\n  interface ProjectSelectorProps {\n    projects: Project[];\n    currentProject: Project | null;\n    onSelect: (project: Project) => void;\n    onAddNew: () => void;\n  }\n  ```\n- **Dependencies:** useProjectStore\n- **Reuses:** Project selector pattern from TelegramLayout\n\n#### 4. DirectoryBrowser\n- **Purpose:** Modal for browsing server filesystem\n- **Interfaces:**\n  ```typescript\n  interface DirectoryBrowserProps {\n    open: boolean;\n    onClose: () => void;\n    onSelect: (path: string) => void;\n  }\n  ```\n- **Dependencies:** Backend /api/browse endpoint\n- **Reuses:** DirectoryBrowser from clipendra (direct adaptation)\n\n#### 5. AgentList\n- **Purpose:** List of agents for current project\n- **Interfaces:**\n  ```typescript\n  interface AgentListProps {\n    agents: Agent[];\n    currentAgentId: string | null;\n    onSelectAgent: (agent: Agent) => void;\n    onSettings: (agent: Agent) => void;\n  }\n  ```\n- **Dependencies:** useAgentStore\n- **Reuses:** ChatListPanel pattern from clipendra\n\n#### 6. AgentSettingsPanel\n- **Purpose:** Edit agent name, system prompt, linked MD files\n- **Interfaces:**\n  ```typescript\n  interface AgentSettingsPanelProps {\n    agent: Agent;\n    onSave: (updates: Partial<Agent>) => void;\n    onClose: () => void;\n  }\n  ```\n- **Dependencies:** useAgentStore, Backend /api/agents/:id\n- **Reuses:** Pattern from clipendra AgentSettingsPanel\n\n#### 7. ChatPanel\n- **Purpose:** Chat interface with message list and input\n- **Interfaces:**\n  ```typescript\n  interface ChatPanelProps {\n    agentId: string;\n    showHeader?: boolean;\n  }\n  ```\n- **Dependencies:** useWebSocket hook, useMessageStore\n- **Reuses:** ChatPanel + MessageBubble from clipendra\n\n#### 8. DocViewer\n- **Purpose:** Render markdown documents with syntax highlighting\n- **Interfaces:**\n  ```typescript\n  interface DocViewerProps {\n    content: string;\n    filename: string;\n  }\n  ```\n- **Dependencies:** react-markdown, rehype-highlight\n- **Reuses:** DocViewer pattern from bolt_ai_front\n\n#### 9. TokenUsageIndicator\n- **Purpose:** Display token usage with warning at 120K\n- **Interfaces:**\n  ```typescript\n  interface TokenUsageProps {\n    inputTokens: number;\n    outputTokens: number;\n    totalTokens: number;\n    warningThreshold?: number; // default 120000\n  }\n  ```\n- **Dependencies:** None\n- **Reuses:** Usage display pattern from clipendra Header\n\n#### 10. MobileTabSwitcher\n- **Purpose:** Bottom sheet for tab selection on mobile\n- **Interfaces:**\n  ```typescript\n  interface MobileTabSwitcherProps {\n    tabs: TabData[];\n    activeTabId: string;\n    onSelectTab: (tabId: string) => void;\n    onCloseTab: (tabId: string) => void;\n    isOpen: boolean;\n    onClose: () => void;\n  }\n  ```\n- **Dependencies:** Tab state\n- **Reuses:** MobileTabSwitcher from bolt_ai_front (direct)\n\n### Backend Services\n\n#### 1. ClaudeCliService\n- **Purpose:** Spawn and manage Claude CLI processes\n- **Interfaces:**\n  ```typescript\n  class ClaudeCliService {\n    spawnClaude(prompt: string, options: ClaudeCliOptions): Promise<{\n      process: ChildProcess;\n      sessionId: string | null;\n    }>;\n\n    streamOutput(\n      process: ChildProcess,\n      ws: WebSocket,\n      sessionId: string,\n      db: DatabaseService\n    ): void;\n\n    cleanup(sessionId: string): void;\n    cleanupAll(): void;\n  }\n  ```\n- **Dependencies:** child_process, ws\n- **Reuses:** ClaudeCliService from clipendra (direct)\n\n#### 2. AuthService\n- **Purpose:** JWT authentication and password hashing\n- **Interfaces:**\n  ```typescript\n  class AuthService {\n    register(email: string, password: string): Promise<{ user: User; token: string }>;\n    login(email: string, password: string): Promise<{ user: User; token: string }>;\n    verifyToken(token: string): Promise<User | null>;\n    hashPassword(password: string): Promise<string>;\n    comparePassword(password: string, hash: string): Promise<boolean>;\n  }\n  ```\n- **Dependencies:** bcrypt, jsonwebtoken\n- **Reuses:** New service, pattern from standard JWT auth\n\n#### 3. ProjectService\n- **Purpose:** CRUD operations for projects\n- **Interfaces:**\n  ```typescript\n  class ProjectService {\n    create(userId: string, workingDirectory: string): Promise<Project>;\n    getByUser(userId: string): Promise<Project[]>;\n    getById(id: string): Promise<Project | null>;\n    delete(id: string): Promise<void>;\n  }\n  ```\n- **Dependencies:** DatabaseService\n- **Reuses:** Pattern from clipendra project handling\n\n#### 4. AgentService\n- **Purpose:** CRUD operations for agents\n- **Interfaces:**\n  ```typescript\n  class AgentService {\n    createDefaultAgents(projectId: string): Promise<Agent[]>;\n    getByProject(projectId: string): Promise<Agent[]>;\n    getById(id: string): Promise<Agent | null>;\n    update(id: string, data: Partial<Agent>): Promise<Agent>;\n    delete(id: string): Promise<void>;\n  }\n  ```\n- **Dependencies:** DatabaseService\n- **Reuses:** New service with default agent creation\n\n#### 5. TranscriptService\n- **Purpose:** Read chat history from CLI transcript files\n- **Interfaces:**\n  ```typescript\n  class TranscriptService {\n    getSessionMessages(sessionId: string): Promise<Message[]>;\n    findProjectPath(workingDirectory: string): Promise<string | null>;\n  }\n  ```\n- **Dependencies:** fs/promises\n- **Reuses:** New service for CLI transcript parsing\n\n#### 6. WebSocketHandler\n- **Purpose:** WebSocket message routing and connection management\n- **Interfaces:**\n  ```typescript\n  function setupWebSocket(server: Server, db: DatabaseService): WebSocketServer;\n  ```\n- **Dependencies:** ws, ClaudeCliService, AuthService\n- **Reuses:** WebSocket handler pattern from clipendra\n\n### Zustand Stores\n\n#### 1. useAuthStore\n```typescript\ninterface AuthState {\n  user: User | null;\n  token: string | null;\n  isLoading: boolean;\n  error: string | null;\n  login: (email: string, password: string) => Promise<void>;\n  register: (email: string, password: string) => Promise<void>;\n  logout: () => void;\n  checkAuth: () => Promise<void>;\n}\n```\n\n#### 2. useProjectStore\n```typescript\ninterface ProjectState {\n  projects: Project[];\n  currentProject: Project | null;\n  isLoading: boolean;\n  fetchProjects: () => Promise<void>;\n  setCurrentProject: (project: Project | null) => void;\n  createProject: (workingDirectory: string) => Promise<Project>;\n  deleteProject: (id: string) => Promise<void>;\n}\n```\n\n#### 3. useAgentStore\n```typescript\ninterface AgentState {\n  agents: Agent[];\n  currentAgent: Agent | null;\n  isLoading: boolean;\n  fetchAgents: (projectId: string) => Promise<void>;\n  setCurrentAgent: (agent: Agent | null) => void;\n  updateAgent: (id: string, data: Partial<Agent>) => Promise<void>;\n  createAgent: (data: CreateAgentDto) => Promise<Agent>;\n  deleteAgent: (id: string) => Promise<void>;\n}\n```\n\n#### 4. useMessageStore\n```typescript\ninterface MessageState {\n  messages: Message[];\n  isLoading: boolean;\n  contextUsage: ContextUsage;\n  addMessage: (message: Message) => void;\n  updateLastMessage: (content: string) => void;\n  setMessages: (messages: Message[]) => void;\n  clearMessages: () => void;\n  setContextUsage: (usage: ContextUsage) => void;\n}\n```\n\n#### 5. useTabStore\n```typescript\ninterface TabState {\n  tabs: TabData[];\n  activeTabId: string | null;\n  openTab: (tab: TabData) => void;\n  closeTab: (id: string) => void;\n  setActiveTab: (id: string) => void;\n}\n```\n\n## Data Models\n\n### User\n```typescript\ninterface User {\n  id: string;              // UUID\n  email: string;           // Unique\n  password_hash: string;   // bcrypt\n  created_at: Date;\n  updated_at: Date;\n}\n```\n\n### Project\n```typescript\ninterface Project {\n  id: string;              // UUID\n  user_id: string;         // FK to users\n  name: string;            // Display name (derived from path)\n  working_directory: string; // Absolute path\n  created_at: Date;\n  updated_at: Date;\n}\n```\n\n### Agent\n```typescript\ninterface Agent {\n  id: string;              // UUID\n  project_id: string;      // FK to projects\n  name: string;            // e.g., \"BackDev\", \"PM\"\n  system_prompt: string;   // Max 10000 chars\n  session_id: string | null; // CLI session ID for --resume\n  linked_md_files: string[]; // Array of file paths\n  created_at: Date;\n  updated_at: Date;\n}\n```\n\n### AgentSession\n```typescript\ninterface AgentSession {\n  id: string;              // UUID\n  agent_id: string;        // FK to agents\n  cli_session_id: string;  // From Claude CLI system event\n  total_input_tokens: number;\n  total_output_tokens: number;\n  total_cost_usd: number;\n  created_at: Date;\n  ended_at: Date | null;\n}\n```\n\n### Default Agent Templates\n```typescript\nconst DEFAULT_AGENTS: Omit<Agent, 'id' | 'project_id' | 'session_id' | 'linked_md_files' | 'created_at' | 'updated_at'>[] = [\n  { name: 'PM', system_prompt: 'You are a Project Manager. Coordinate tasks, review progress, make architectural decisions. Focus on planning and delegation.' },\n  { name: 'Research', system_prompt: 'You are a Research agent. Study documentation, analyze codebases, find solutions. Provide detailed findings with sources.' },\n  { name: 'BackDev', system_prompt: 'You are a Backend Developer. Write Node.js/TypeScript code, implement APIs, handle database operations. Follow best practices.' },\n  { name: 'FrontDev', system_prompt: 'You are a Frontend Developer. Build React components with TypeScript and TailwindCSS. Focus on responsive, accessible UI.' },\n  { name: 'DevOps', system_prompt: 'You are a DevOps engineer. Manage Docker, containers, deployment configurations. Optimize infrastructure.' },\n  { name: 'CI/CD', system_prompt: 'You are a CI/CD specialist. Configure GitHub Actions, pipelines, automated testing and deployment workflows.' },\n  { name: 'Docs', system_prompt: 'You are a Documentation specialist. Write clear, comprehensive documentation in Markdown. Keep docs in sync with code.' }\n];\n```\n\n## Database Schema\n\n```sql\n-- Users table\nCREATE TABLE users (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  email VARCHAR(255) UNIQUE NOT NULL,\n  password_hash VARCHAR(255) NOT NULL,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP\n);\n\n-- Projects table\nCREATE TABLE projects (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n  name VARCHAR(255) NOT NULL,\n  working_directory VARCHAR(1024) NOT NULL,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n  UNIQUE(user_id, working_directory)\n);\n\n-- Agents table\nCREATE TABLE agents (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,\n  name VARCHAR(100) NOT NULL,\n  system_prompt TEXT CHECK (char_length(system_prompt) <= 10000),\n  session_id VARCHAR(255),\n  linked_md_files JSONB DEFAULT '[]'::jsonb,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP\n);\n\n-- Agent sessions table (for token tracking)\nCREATE TABLE agent_sessions (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  agent_id UUID NOT NULL REFERENCES agents(id) ON DELETE CASCADE,\n  cli_session_id VARCHAR(255) NOT NULL,\n  total_input_tokens INTEGER DEFAULT 0,\n  total_output_tokens INTEGER DEFAULT 0,\n  total_cost_usd DECIMAL(10, 6) DEFAULT 0,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n  ended_at TIMESTAMP WITH TIME ZONE\n);\n\n-- Indexes\nCREATE INDEX idx_projects_user_id ON projects(user_id);\nCREATE INDEX idx_agents_project_id ON agents(project_id);\nCREATE INDEX idx_agent_sessions_agent_id ON agent_sessions(agent_id);\n```\n\n## API Endpoints\n\n### Authentication\n```\nPOST /api/auth/register\n  Body: { email: string, password: string }\n  Response: { user: User, token: string }\n\nPOST /api/auth/login\n  Body: { email: string, password: string }\n  Response: { user: User, token: string }\n\nGET /api/auth/me\n  Headers: Authorization: Bearer <token>\n  Response: { user: User }\n```\n\n### Projects\n```\nGET /api/projects\n  Headers: Authorization: Bearer <token>\n  Response: { projects: Project[] }\n\nPOST /api/projects\n  Headers: Authorization: Bearer <token>\n  Body: { working_directory: string }\n  Response: { project: Project }\n\nDELETE /api/projects/:id\n  Headers: Authorization: Bearer <token>\n  Response: { success: boolean }\n```\n\n### Agents\n```\nGET /api/projects/:projectId/agents\n  Headers: Authorization: Bearer <token>\n  Response: { agents: Agent[] }\n\nGET /api/agents/:id\n  Headers: Authorization: Bearer <token>\n  Response: { agent: Agent }\n\nPUT /api/agents/:id\n  Headers: Authorization: Bearer <token>\n  Body: { name?: string, system_prompt?: string, linked_md_files?: string[] }\n  Response: { agent: Agent }\n\nPOST /api/projects/:projectId/agents\n  Headers: Authorization: Bearer <token>\n  Body: { name: string, system_prompt: string }\n  Response: { agent: Agent }\n\nDELETE /api/agents/:id\n  Headers: Authorization: Bearer <token>\n  Response: { success: boolean }\n```\n\n### Files\n```\nGET /api/browse\n  Headers: Authorization: Bearer <token>\n  Query: { path?: string }\n  Response: { currentPath: string, parentPath: string | null, items: DirectoryItem[] }\n\nGET /api/files/read\n  Headers: Authorization: Bearer <token>\n  Query: { path: string }\n  Response: { content: string }\n```\n\n### WebSocket Protocol\n```typescript\n// Client -> Server\ninterface QueryMessage {\n  type: 'query';\n  prompt: string;\n  sessionId: string;  // UI session ID\n  agentId: string;\n  projectId: string;\n}\n\n// Server -> Client\ninterface ConnectedMessage {\n  type: 'connected';\n  sessionId: string;\n  model: string;\n  cwd: string;\n  claudeSessionId: string;\n}\n\ninterface StreamMessage {\n  type: 'stream';\n  content: {\n    type: 'assistant';\n    message: {\n      content: string;\n      id: string;\n      usage?: TokenUsage;\n    };\n  };\n  sessionId: string;\n}\n\ninterface CompleteMessage {\n  type: 'complete';\n  result: any;\n  usage: TokenUsage;\n  cost: number;\n  duration: number;\n  numTurns: number;\n  isError: boolean;\n  sessionId: string;\n}\n\ninterface ErrorMessage {\n  type: 'error';\n  error: string;\n  code: string;\n  sessionId: string;\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **CLI Not Authenticated**\n   - **Detection:** stderr contains \"claude login\"\n   - **Handling:** Return specific error code `CLAUDE_LOGIN_REQUIRED`\n   - **User Impact:** Show modal: \"Claude CLI is not authenticated. Run `claude login` in terminal.\"\n\n2. **Terms Update Required**\n   - **Detection:** stderr contains \"consumer terms\"\n   - **Handling:** Return error code `CLAUDE_TERMS_REQUIRED`\n   - **User Impact:** Show modal: \"Anthropic requires you to accept updated terms. Run `claude` in terminal.\"\n\n3. **WebSocket Disconnect**\n   - **Detection:** onclose event with wasClean=false\n   - **Handling:** Exponential backoff reconnection (1s, 2s, 4s... max 30s)\n   - **User Impact:** Show reconnecting indicator, queue messages\n\n4. **CLI Process Timeout**\n   - **Detection:** No result event within timeout (10 minutes default)\n   - **Handling:** Kill process, send timeout error\n   - **User Impact:** Show error: \"Request timed out. Try a shorter message.\"\n\n5. **Token Limit Warning**\n   - **Detection:** totalTokens >= 120,000\n   - **Handling:** Emit warning event\n   - **User Impact:** Show yellow banner: \"Context limit approaching. Consider starting new session.\"\n\n6. **Invalid JWT**\n   - **Detection:** Token verification fails\n   - **Handling:** Return 401, clear client token\n   - **User Impact:** Redirect to login page\n\n7. **Project Path Conflict**\n   - **Detection:** working_directory already exists for user\n   - **Handling:** Return 409 Conflict\n   - **User Impact:** Show error: \"This directory is already registered as a project.\"\n\n## Testing Strategy\n\n### Unit Testing\n\n**Frontend (Vitest + React Testing Library):**\n- Zustand stores: Test state transitions and async actions\n- Components: Test rendering and user interactions\n- Hooks: Test useWebSocket connection states and message handling\n- Utils: Test markdown parsing, path utilities\n\n**Backend (Vitest):**\n- ClaudeCliService: Mock spawn, test argument building and event parsing\n- AuthService: Test password hashing, JWT generation\n- Services: Test CRUD operations with mocked database\n\n**Coverage Target:** 70% for services, 50% for components\n\n### Integration Testing\n\n**API Routes:**\n- Auth flow: register -> login -> access protected route -> logout\n- Project flow: create project -> add agents -> update agent -> delete\n- File browsing: navigate directories, verify path security\n\n**WebSocket:**\n- Connection lifecycle: connect -> authenticate -> query -> stream -> complete\n- Reconnection: disconnect -> reconnect -> resume session\n- Error handling: invalid messages, timeout scenarios\n\n### End-to-End Testing\n\n**Critical User Flows (Playwright):**\n1. **New User Onboarding:**\n   - Register -> Create first project -> Chat with default agent -> View token usage\n\n2. **Returning User:**\n   - Login -> Select project -> Resume previous conversation -> Continue chatting\n\n3. **Mobile Experience:**\n   - Navigate between agents (swipe) -> Chat -> View linked doc -> Switch tabs\n\n4. **Agent Configuration:**\n   - Open settings -> Edit system prompt -> Add linked MD file -> Save -> Verify in chat\n\n**Environments:**\n- Local: Docker Compose with PostgreSQL\n- CI: GitHub Actions with containerized services\n\n## Security Considerations\n\n1. **Authentication:**\n   - JWT tokens with 24-hour expiration\n   - Password hashing with bcrypt (cost factor 10)\n   - Secure token storage in localStorage (MVP) -> httpOnly cookies (future)\n\n2. **Input Validation:**\n   - Zod schemas on all API inputs\n   - Path traversal prevention in file browser\n   - XSS prevention via React's default escaping\n\n3. **Authorization:**\n   - User can only access own projects/agents\n   - WebSocket connections require valid JWT\n   - Path ownership verification in DirectoryBrowser\n\n4. **CLI Security:**\n   - Use `--dangerously-skip-permissions` only when explicitly enabled\n   - Default to `--permission-mode=acceptEdits`\n   - No secrets passed via CLI arguments\n\n## Deployment Architecture\n\n```yaml\n# docker-compose.yml\nversion: '3.8'\nservices:\n  qomplex-app:\n    build: .\n    ports:\n      - \"3000:3000\"\n    environment:\n      - DATABASE_URL=postgresql://qomplex:password@qomplex-postgres:5432/qomplex\n      - JWT_SECRET=${JWT_SECRET}\n      - NODE_ENV=production\n    volumes:\n      - /home/dev:/home/dev:ro  # Read-only access to projects\n      - ~/.claude:/.claude:ro    # Read-only access to CLI transcripts\n    depends_on:\n      - qomplex-postgres\n\n  qomplex-postgres:\n    image: postgres:16\n    volumes:\n      - postgres_data:/var/lib/postgresql/data\n    environment:\n      - POSTGRES_USER=qomplex\n      - POSTGRES_PASSWORD=password\n      - POSTGRES_DB=qomplex\n\nvolumes:\n  postgres_data:\n```\n\n**Health Checks:**\n- `GET /health` - Basic liveness check\n- `GET /health/ready` - Database connection check\n\n**Environment Variables:**\n- `DATABASE_URL` - PostgreSQL connection string\n- `JWT_SECRET` - Secret for JWT signing (32+ chars)\n- `CLAUDE_CLI_TIMEOUT_MS` - CLI timeout (default 600000)\n- `PORT` - Server port (default 3000)\n- `NODE_ENV` - Environment (development/production)\n\n---\n\n*Last updated: December 2025*\n",
  "fileStats": {
    "size": 26816,
    "lines": 862,
    "lastModified": "2025-12-01T20:42:05.545Z"
  },
  "comments": []
}